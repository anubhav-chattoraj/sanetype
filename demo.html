<head>
  <meta charset="UTF-8">
  <title>Sanetype Demo for Devnāgri</title>
  <style type="text/css">
    textarea {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 90%;
      height: 90%;
    }
  </style>
</head>

<body>
  <textarea data-sanetype="dev" rows=30 cols=100 ></textarea>
  
  <script type="text/javascript">
    var sanetype_handle = function(e, script) {
      var removeHere = function(el, str) { 
        var start = el.selectionStart;
        var end = el.selectionEnd;
        el.value = el.value.substring(0, start - (str.length - 1)) + el.value.substring(end, el.value.length);
        el.selectionStart = start - str.length + 1;
        el.selectionEnd = el.selectionStart;
      }
      
      var insertHere = function(el, str) { 
        var start = el.selectionStart;
        var end = el.selectionEnd;
        el.value = el.value.substring(0, start) + str + el.value.substring(end, el.value.length);
        el.selectionStart = start + str.length;
        el.selectionEnd = el.selectionStart;
      }
      
      var t = e.target;
      var char = String.fromCharCode(e.charCode); 
      
      if(typeof t.dataset.next == 'undefined' || script.follow.indexOf(t.dataset.next) == -1) {
        t.dataset.next = '';
      }
      t.dataset.next += char;
      var match = script.get(t.dataset.next);
      if(match == null) { t.dataset.next = char; match = script.get(char); }
      
      console.log("NEXT: "+t.dataset.next + " MATCH: "+match);
      if(match == null && script.follow.indexOf(t.dataset.next) == -1) {
        t.dataset.next = '';
      } else {
        e.preventDefault();
        removeHere(t, t.dataset.next);
        insertHere(t, match);
      }
    }
    
    var addToMap = function(map, key, value) {
      map.keys.push(key);
      map.values.push(value);
    }
    var getFromMap = function(map, key) {
      for(var i = 0; i < map.keys.length; i++) {
        console.log(map.keys[i] + " " + map.values[i]);
        if(map.keys[i] == key)  return map.values[i];
      }
      return null;
    }
    
    var dev = {
      map: { keys: [], values: [] },
      add: function(key, value) { addToMap(dev.map, key, value); }, 
      get: function(key) { return getFromMap(dev.map, key); },
      follow: ['k', 'g', 'c', 'j', 'T', 'D', 'R', 't', 'd', 'p', 'b', ','],
      init: function(settings) {
        dev.add('k', 'क'); dev.add('kh', 'ख'); dev.add('g', 'ग'); dev.add('gh', 'घ'); dev.add('G', 'ङ');
        dev.add('c', 'च'); dev.add('ch', 'छ'); dev.add('j', 'ज'); dev.add('jh', 'झ'); dev.add(',n', 'ञ');
      }
    }
    
    initialized = [];
    var init_sanetype = function(script) {
      if (initialized.indexOf(script) == -1) {
        script.init(); initialized.push(script);
      }
    }
    var elements = document.querySelectorAll("[data-sanetype]");
    for (var i = 0; i < elements.length; i++) {
      if (elements[i].dataset.sanetype == 'dev') {
        init_sanetype(dev);
        elements[i].addEventListener('keypress', function(e) { sanetype_handle(e, dev) }, false);
      }
    }
  </script>
  
</body>