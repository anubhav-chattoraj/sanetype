<head>
  <meta charset="UTF-8">
  <title>Sanetype Demo for Devnāgri</title>
  <style type="text/css">
    textarea {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 90%;
      height: 90%;
    }
  </style>
</head>

<body>
  <textarea data-sanetype="dev" rows=30 cols=100 ></textarea>
  
  <script type="text/javascript">
    var sanetype_handle = function(e, map, follow) {
      var removeHere = function(el, str) { 
        var start = el.selectionStart;
        var end = el.selectionEnd;
        el.value = el.value.substring(0, start - (str.length - 1)) + el.value.substring(end, el.value.length);
        el.selectionStart = start - str.length + 1;
        el.selectionEnd = el.selectionStart;
      }
      
      var insertHere = function(el, str) { 
        var start = el.selectionStart;
        var end = el.selectionEnd;
        el.value = el.value.substring(0, start) + str + el.value.substring(end, el.value.length);
        el.selectionStart = start + str.length;
        el.selectionEnd = el.selectionStart;
      }
      
      var t = e.target;
      var char = String.fromCharCode(e.charCode); 
      
      if(typeof t.dataset.next == 'undefined' || typeof follow[t.dataset.next] == 'undefined' 
          || typeof follow[t.dataset.next][char] == 'undefined') {
        t.dataset.next = '';
      }
      t.dataset.next += char;
      var match = map[t.dataset.next];
      if(match == null && typeof[follow][t.dataset.next] == 'undefined') {
        t.dataset.next = ''
      } else {
        e.preventDefault();
        removeHere(t, t.dataset.next);
        insertHere(t, match);
      }
    }
    
    var dev = {
      map: {
        k: 'क', kh: 'ख', g: 'ग', gh: 'घ', G: 'ङ'
      },
      
      follow: {
        k: { h: null }, g: { h: null }
      },
      
      handle: function(e) { sanetype_handle(e, dev.map, dev.follow); }
    }
    
    var elements = document.querySelectorAll("[data-sanetype]");
    for (var i = 0; i < elements.length; i++) {
      if (elements[i].dataset.sanetype == 'dev') {
        elements[i].addEventListener('keypress', dev.handle, false);
      }
    }
  </script>
  
</body>