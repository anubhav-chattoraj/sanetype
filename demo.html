<head>
  <meta charset="UTF-8">
  <title>Sanetype Demo for Devnāgri</title>
  <style type="text/css">
    textarea {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 90%;
      height: 90%;
      font-size: 15pt;
    }
  </style>
</head>

<body>
  <textarea data-sanetype="dev" rows=30 cols=100 ></textarea>
  
  <script type="text/javascript">
  // TODO Make so that only consonants can be geminated
  // TODO Ignore keypresses when control pressed 
    var sanetype_handle = function(e, script) {
      var t = e.target;
      
      var removeHere = function(numChars) { 
        var start = t.selectionStart;
        var end = t.selectionEnd;
        t.value = t.value.substring(0, start - numChars) + t.value.substring(end, t.value.length);
        t.selectionStart = start - numChars;
        t.selectionEnd = t.selectionStart;
      }
      
      var insertHere = function(str) { 
        var start = t.selectionStart;
        var end = t.selectionEnd;
        t.value = t.value.substring(0, start) + str + t.value.substring(end, t.value.length);
        t.selectionStart = start + str.length;
        t.selectionEnd = t.selectionStart;
      }
      
      var char = String.fromCharCode(e.charCode); 
      if(typeof t.dataset.buffer === 'undefined') t.dataset.buffer = '';
      if(typeof t.dataset.geminate === 'undefined') t.dataset.geminate ='no';
       
      if(char === 'q') { // geminates
        e.preventDefault();
        t.dataset.geminate = '1';
        return;
      }
      
      if(script.follow.indexOf(t.dataset.buffer) === -1) {
        t.dataset.buffer = '';
      }
      var prevMatch = script.get(t.dataset.buffer);
      var numCharsToDelete;
      if(prevMatch === null){
        if (t.dataset.buffer.match(/^[a-zA-Z]+$/) === null) // contains punctuation marks; reflected on screen
          numCharsToDelete = t.dataset.buffer.length; 
        else numCharsToDelete = 0; 
      } else numCharsToDelete = prevMatch.length;
      
      t.dataset.buffer += char;
      var match = script.get(t.dataset.buffer);
      
      if(match == null && script.follow.indexOf(t.dataset.buffer) === -1) {
        // ignore the characters previously stored in the buffer
        numCharsToDelete = 0; t.dataset.buffer = char; match = script.get(char); 
        if(t.dataset.geminate === 'change') t.dataset.geminate = 'no'; 
      }
      
      if(char.match(/^[a-zA-Z]$/) || script.map.keys.indexOf(t.dataset.buffer) !== -1) e.preventDefault();
      
      if(match == null) {
        if (script.follow.indexOf(t.dataset.buffer) === -1)
          t.dataset.buffer = '';
      } else {
        if(t.dataset.geminate === '1'){
          if(prevMatch === null) removeHere(numCharsToDelete);
          insertHere(match + '्' + match); 
          if(script.unaspirated.indexOf(match) !== -1) {
            // next call will properly insert the second part of geminate
            t.dataset.geminate = 'no';
          } else if(script.follow.indexOf(t.dataset.buffer) === -1) {
            // unambiguous
            t.dataset.geminate = 'no';
            t.dataset.buffer = '';
          } else { // ambiguous; commit now, fix later
            t.dataset.geminate = 'change';
          }
        } else if (t.dataset.geminate === 'change') {
          if(numCharsToDelete !== 0) { // if control doesn't flow here, last commit was correct
            removeHere(2*numCharsToDelete + 1);
            insertHere(match + '्' + match);
          }
          t.dataset.geminate = 'no';
        }else { 
          removeHere(numCharsToDelete);
          insertHere(match);
        } 
      }
    }
    
    var addToMap = function(map, key, value) {
      map.keys.push(key);
      map.values.push(value);
    }
    var getFromMap = function(map, key) {
      for(var i = 0; i < map.keys.length; i++) {
        if(map.keys[i] == key)  return map.values[i];
      }
      return null;
    }
    
    var dev = {
      map: { keys: [], values: [] },
      add: function(key, value) { addToMap(dev.map, key, value); }, 
      get: function(key) { return getFromMap(dev.map, key); },
      follow: [',', 'A', 'I', 'U', ',R', ',L', 'O', 'Oo', 'Uu', 
        'a', 'i', 'u',  ',r', ',l', 'o', 'oo', 'uu',
        'k', 'g', 'c', 'j', 'T', 'D', 'R', 't', 'd', 'p', 'b', 's', 'h', '>'],
      unaspirated: ['क', 'ग', 'च', 'ज', 'ट', 'ड', 'ड़', 'त', 'द', 'प', 'ब'], 
      init: function(settings) {
        var a = dev.add;
        a('A', 'अ'); a('a', 'ा'); a('Aa', 'आ'); a('aa', 'ा');
        a('I', 'इ'); a('i', 'ि'); a('Ii', 'ई'); a('ii', 'ी');
        a('U', 'उ'); a('u', 'ु'); a('Uu', 'ऊ'); a('uu', 'ू');
        a(',R', 'ऋ'); a(',r', 'ृ'); a(',Rr', 'ॠ'); a(',rr', 'ॄ');
        a(',L', 'ऌ'); a(',l', 'ॢ'); a(',Ll', 'ॡ'); a(',ll', 'ॣ');
        a('E', 'ए'); a('e', 'े'); a('Ai', 'ऐ'); a('ai', 'ै'); a('Ae', 'ॲ'); a('ae', 'ॅ');
        a('O', 'ओ'); a('o', 'ो'); a('Au', 'औ'); a('au', 'ौ'); a('Ao', 'ऑ'); a('ao', 'ॉ');
        a('Ue', 'ॶ'); a('ue', 'ॖ'); a('Uue', 'ॷ'); a('uue', 'ॗ');
        a('Oe', 'ॳ'); a('oe', 'ऺ'); a('Ooe', 'ॴ'); a('ooe', 'ऻ');
        a('Aw', 'ॵ'); a('aw', 'ॏ'); a('Ee', 'ऍ'); a('ee', 'ॅ');
        a('k', 'क'); a('kh', 'ख'); a('g', 'ग'); a('gh', 'घ'); a('G', 'ङ');
        a('c', 'च'); a('ch', 'छ'); a('j', 'ज'); a('jh', 'झ'); a(',n', 'ञ'); a('z', 'ज़');
        a('T', 'ट'); a('Th', 'ठ'); a('D', 'ड'); a('Dh', 'ढ'); a('N', 'ण'); a('R', 'ड़'); a('Rh', 'ढ़');
        a('t', 'त'); a('th', 'थ'); a('d', 'द'); a('dh', 'ध'); a('n', 'न');
        a('p', 'प'); a('ph', 'फ'); a('b', 'ब'); a('bh', 'भ'); a('m', 'म'); a('f', 'फ़');
        a('y', 'य'); a('r', 'र'); a('l', 'ल'); a('v', 'व'); a('L', 'ळ');
        a('sh', 'श'); a('S', 'ष'); a('s', 'स'); a('H', 'ह');
        a('K', 'क्ष'); a('J', 'ज्ञ');
        a('w', '्र'); a('W', 'र्'); a('<', 'ऱ्'); a('Y', '्य'); a('V', '्व'); a('h', '्ह');
        a(',g', 'ॻ'); a(',j', 'ॼ'); a(',D', 'ॾ'); a(',b', 'ॿ'); a('hh', 'ॽ');
        a('X', 'ँ'); a('M', 'ं'); a(':', 'ः'); a('Q', '़'); a('x', '्'); a('\'', 'ʼ');
        a('>', '।'); a('>>', '॥'); a('$', '₹'); a('&', 'ऽ'); a(',M', 'ॐ'); a(',,', '॰');
      }
    }
    
    initialized = [];
    var init_sanetype = function(script) {
      if (initialized.indexOf(script) === -1) {
        script.init(); initialized.push(script);
      }
    }
    var elements = document.querySelectorAll("[data-sanetype]");
    for (var i = 0; i < elements.length; i++) {
      if (elements[i].dataset.sanetype === 'dev') {
        init_sanetype(dev);
        elements[i].addEventListener('keypress', function(e) { sanetype_handle(e, dev) }, false);
      }
    }
  </script>
  
</body>