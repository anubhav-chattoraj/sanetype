<head>
  <meta charset="UTF-8">
  <title>Sanetype Demo for Devnāgri</title>
  <style type="text/css">
    textarea {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 90%;
      height: 90%;
    }
  </style>
</head>

<body>
  <textarea data-sanetype="dev" rows=30 cols=100 ></textarea>
  
  <script type="text/javascript">
    var sanetype_handle = function(e, map) {
      var removeHere = function(el, str) {
        el.value = el.value.substring(0, el.selectionStart - (str.length - 1)) + 
          el.value.substring(el.SelectionEnd, el.value.length);
        el.selectionStart -= (str.length - 1);
        el.selectionEnd   = el.selectionStart;
      }
      
      var insertHere = function(el, str) {
        el.value = el.value.substring(0, el.selectionStart) + str + 
          el.value.substring(el.selectionEnd, el.value.length);
        el.selectionStart += str.length;
        el.selectionEnd = el.selectionStart;
      }
      
      var t = e.target;
      var char = String.fromCharCode(e.charCode); 
      if (typeof t.dataset.next == 'undefined') {
        t.dataset.next = '';
      }
      
      t.dataset.next += char;
      console.log("char "+char);
      var match = map[char];
      console.log("match "+match);
      if(match != null) {
        removeHere(t, t.dataset.next);
        insertHere(t, match);
        t.dataset.next = '';
      }
    }
    
    var dev = {
      map: {
        k: 'क', kh: 'ख', g: 'ग', gh: 'घ'
      },
      
      handle: function(e) { sanetype_handle(e, dev.map); }
    }
    
    var elements = document.querySelectorAll("[data-sanetype]");
    for (var i = 0; i < elements.length; i++) {
      if (elements[i].dataset.sanetype == 'dev') {
        elements[i].addEventListener('keypress', dev.handle, false);
      }
    }
  </script>
  
</body>